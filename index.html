<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>蔵書管理（ISBNスキャン）</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QuaggaJS CDN -->
  <script src="https://serratus.github.io/quaggaJS/examples/js/quagga.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-4xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">蔵書管理（ISBNバーコード）</h1>
      <p class="text-sm text-gray-500">カメラでISBNを読み取り、書名と著者を登録します。</p>
    </header>

    <!-- コントロール -->
    <div class="flex gap-2 mb-4">
      <button id="startBtn" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">カメラ起動</button>
      <button id="stopBtn" class="px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300">カメラ停止</button>
      <span id="status" class="ml-auto text-sm text-gray-500">待機中</span>
    </div>

    <!-- カメラ映像（小さめ） -->
    <div class="mb-6">
      <div class="border rounded bg-black/80 w-full max-w-sm aspect-video overflow-hidden">
        <div id="interactive" class="h-full w-full relative"></div>
      </div>
      <p class="text-xs text-gray-500 mt-1">カメラ枠は小さめに表示。枠内にバーコード（EAN-13/ISBN）を収めてください。</p>
    </div>

    <!-- 直近検出 -->
    <div class="mb-4">
      <div class="p-3 rounded border bg-white">
        <div class="text-sm text-gray-600">検出したISBN</div>
        <div id="lastIsbn" class="text-lg font-mono mt-1">-</div>
        <div id="lookupMsg" class="text-sm text-gray-500 mt-1">-</div>
      </div>
    </div>

    <!-- リスト -->
    <section>
      <h2 class="text-xl font-semibold mb-2">登録済みの書籍</h2>
      <ul id="bookList" class="space-y-2"></ul>
      <div class="mt-3">
        <button id="clearAll" class="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700">すべて削除</button>
      </div>
    </section>
  </div>

  <script>
    // ストレージキー
    const STORAGE_KEY = "bookshelf_items_v1";

    // ロード
    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    // 保存（最新が先頭）
    function saveItems(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    // リスト描画
    function renderList() {
      const list = document.getElementById("bookList");
      list.innerHTML = "";
      const items = loadItems();
      items.forEach((item, idx) => {
        const li = document.createElement("li");
        li.className = "p-3 rounded border bg-white flex items-start gap-3";
        li.innerHTML = `
          <div class="flex-1">
            <div class="text-base font-medium">${escapeHtml(item.title || "タイトル不明")}</div>
            <div class="text-sm text-gray-600">著者: ${escapeHtml(item.authors?.join(", ") || "不明")}</div>
            <div class="text-xs text-gray-500 mt-1">ISBN: ${escapeHtml(item.isbn)}</div>
            <div class="text-xs text-gray-400">登録: ${new Date(item.addedAt).toLocaleString()}</div>
          </div>
          <div>
            <button data-index="${idx}" class="delBtn px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300">削除</button>
          </div>
        `;
        list.appendChild(li);
      });

      // 削除ボタン
      list.querySelectorAll(".delBtn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const index = Number(e.currentTarget.getAttribute("data-index"));
          const arr = loadItems();
          arr.splice(index, 1);
          saveItems(arr);
          renderList();
        });
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    // 重複チェック
    function isDuplicate(isbn) {
      const items = loadItems();
      return items.some(x => x.isbn === isbn);
    }

    // 先頭に追加
    function addItemFront(item) {
      const items = loadItems();
      items.unshift(item);
      saveItems(items);
      renderList();
    }

    // Open Library でISBNから書誌情報取得
    // 優先: Search APIで1件取得→不足時Books API参照
    async function fetchBookByISBN(isbn) {
      // ISBNフォーマット正規化（数字のみ）
      const clean = isbn.replace(/[^0-9Xx]/g, "");
      // Search API (jscmdなし、limit=1)
      const searchUrl = `https://openlibrary.org/search.json?isbn=${encodeURIComponent(clean)}&limit=1`;
      try {
        const res = await fetch(searchUrl, { cache: "no-store" });
        if (res.ok) {
          const data = await res.json();
          if (data && data.docs && data.docs.length > 0) {
            const doc = data.docs[0];
            const title = doc.title || null;
            const authors = doc.author_name || [];
            return { title, authors, source: "search" };
          }
        }
      } catch (e) {
        console.warn("Search API failed", e);
      }

      // Books API（legacy）
      const booksUrl = `https://openlibrary.org/api/books?bibkeys=ISBN:${encodeURIComponent(clean)}&jscmd=data&format=json`;
      try {
        const res2 = await fetch(booksUrl, { cache: "no-store" });
        if (res2.ok) {
          const json = await res2.json();
          const key = `ISBN:${clean}`;
          const entry = json[key];
          if (entry) {
            const title = entry.title || null;
            const authors = (entry.authors || []).map(a => a.name).filter(Boolean);
            return { title, authors, source: "books" };
          }
        }
      } catch (e) {
        console.warn("Books API failed", e);
      }
      return { title: null, authors: [] };
    }

    // ISBN-13 チェックディジット検証（EAN-13）
    function isValidIsbn13(code) {
      if (!/^\d{13}$/.test(code)) return false;
      const digits = code.split("").map(n => parseInt(n, 10));
      const check = digits.pop();
      let sum = 0;
      for (let i = 0; i < digits.length; i++) {
        sum += digits[i] * (i % 2 === 0 ? 1 : 3);
      }
      const remainder = sum % 10;
      const calc = remainder === 0 ? 0 : 10 - remainder;
      return check === calc;
    }

    // Quagga 管理
    let quaggaRunning = false;
    let detectLock = false; // 検出直後の多重処理防止

    function updateStatus(text) {
      document.getElementById("status").textContent = text;
    }

    function startCamera() {
      if (quaggaRunning) return;
      // 初期化
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            facingMode: "environment",
            // 小さめプレビューでも解像度はそこそこ確保
            width: { ideal: 640 },
            height: { ideal: 360 }
          }
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, Math.min(4, navigator.hardwareConcurrency - 1)) : 2,
        decoder: {
          // ISBNは通常 EAN-13
          readers: ["ean_reader"]
        },
        locate: true
      }, (err) => {
        if (err) {
          console.error(err);
          updateStatus("初期化失敗");
          return;
        }
        Quagga.start();
        quaggaRunning = true;
        updateStatus("スキャン中");
      });

      Quagga.onDetected(onDetectedHandler);
    }

    function stopCamera() {
      if (!quaggaRunning) return;
      Quagga.offDetected(onDetectedHandler);
      Quagga.stop();
      quaggaRunning = false;
      updateStatus("停止中");
    }

    async function onDetectedHandler(result) {
      if (detectLock) return;
      const code = result?.codeResult?.code || "";
      // ISBN/EAN-13のみ対象
      if (!/^\d{13}$/.test(code)) return;
      if (!isValidIsbn13(code)) return;

      detectLock = true;
      document.getElementById("lastIsbn").textContent = code;
      document.getElementById("lookupMsg").textContent = "書誌情報を取得中…";

      try {
        // 978/979 でISBN-13
        if (!code.startsWith("978") && !code.startsWith("979")) {
          document.getElementById("lookupMsg").textContent = "ISBNではない可能性があります";
          return;
        }
        // 重複回避
        if (isDuplicate(code)) {
          document.getElementById("lookupMsg").textContent = "すでに登録済みです（重複は登録しません）";
          return;
        }
        const info = await fetchBookByISBN(code);
        const title = info.title || "タイトル不明";
        const authors = info.authors && info.authors.length ? info.authors : ["不明"];
        addItemFront({
          isbn: code,
          title,
          authors,
          addedAt: Date.now()
        });
        document.getElementById("lookupMsg").textContent = "登録しました";
      } catch (e) {
        console.error(e);
        document.getElementById("lookupMsg").textContent = "取得または登録に失敗しました";
      } finally {
        // 短いクールダウンで多重登録防止
        setTimeout(() => { detectLock = false; }, 1200);
      }
    }

    // ボタン
    document.getElementById("startBtn").addEventListener("click", startCamera);
    document.getElementById("stopBtn").addEventListener("click", stopCamera);

    document.getElementById("clearAll").addEventListener("click", () => {
      if (confirm("すべての登録を削除しますか？")) {
        saveItems([]);
        renderList();
      }
    });

    // 初期描画
    renderList();
  </script>
</body>
</html>
